# ROS2 Workspace — `tesis_launch`

This workspace contains the ROS2 Humble package for the POCHITA quadruped sensor network. All sensor nodes, the monitoring GUI, and visualization tools are organized under the `tesis_launch` package.

**Target platform:** Raspberry Pi 5 — Ubuntu 24.04  
**Development platform:** PC — Ubuntu 22.04 + ROS2 Humble

---

## Workspace Structure

```
ros2_ws/
├── src/
│   └── tesis_launch/
│       ├── package.xml               ← Package manifest + ROS2 dependencies
│       ├── setup.py                  ← Entry points for all executable nodes
│       ├── setup.cfg
│       ├── launch/                   ← .launch.py files
│       └── tesis_launch/             ← Python source nodes
│           ├── __init__.py
│           ├── can_node.py           ← CAN Bus → serial_data
│           ├── gps.py                ← GPS → gps/fix
│           ├── camarafiltro.py       ← Camera + YOLOv5 → video_detections
│           ├── image_publisher.py    ← Raw image publisher
│           ├── image_sus.py          ← Image subscriber
│           ├── interfaz_open3d.py    ← Main monitoring GUI (MVC View)
│           ├── rviz_launcher_node.py ← Launches RViz2 programmatically
│           ├── comandos_pub.py       ← Motion command publisher
│           ├── comandos_sus.py       ← Commands → CAN bridge
│           ├── prueba_stl.py         ← 3D STL viewer with VTK
│           ├── prueba_stl_sinvtk.py  ← 3D STL viewer without VTK
│           ├── POCHITA_v30.stl       ← Robot 3D model
│           ├── yolov5nu.pt           ← YOLOv5-nano model weights (~5.4 MB)
│           ├── rviz/                 ← RViz2 configuration (.rviz files)
│           └── resource/             ← Package resource marker
└── test/                             ← Unit tests
```

---

## Prerequisites

Make sure the following are installed before building:

```bash
# ROS2 Humble
source /opt/ros/humble/setup.bash

# RPLiDAR driver
sudo apt install ros-humble-rplidar-ros

# Python dependencies
pip install opencv-python open3d python-can pyserial torch torchvision

# rosdep (if not already initialized)
sudo rosdep init
rosdep update
```

---

## Build Instructions

### 1. Navigate to the workspace

```bash
cd ros2_ws
```

### 2. Install declared ROS2 dependencies

```bash
rosdep install --from-paths src --ignore-src -r -y
```

### 3. Build

```bash
colcon build --symlink-install
```

> `--symlink-install` symlinks Python source files instead of copying them, so any edits to `.py` nodes take effect immediately without rebuilding.

### 4. Source the workspace overlay

```bash
source install/setup.bash
```

Add to `~/.bashrc` to avoid sourcing on every terminal session:

```bash
echo "source ~/robot-quadruped-sensor-network/ros2_ws/install/setup.bash" >> ~/.bashrc
```

---

## CAN Bus Setup (required before running `can_node`)

The Linux SocketCAN interface must be configured once per boot (or via a startup service):

```bash
sudo ip link set can0 type can bitrate 500000
sudo ip link set up can0

# Verify
ip link show can0
candump can0    # Optional: monitor raw CAN frames
```

> The CAN bitrate must match the MCP2515 configuration on all Arduino Nano nodes (default: 500,000 bps).

---

## Running Nodes

### Full system

```bash
ros2 launch tesis_launch script_launch.py
```

## Inspect the Running System

```bash
# List all active topics
ros2 topic list

# Monitor CAN sensor data
ros2 topic echo /serial_data

# Check GPS fix
ros2 topic echo /gps/fix

# Visual node/topic graph
rqt_graph
```

---

## Common Issues

| Problem | Likely Cause | Solution |
|---------|-------------|----------|
| `can_node` crashes on start | `can0` not initialized | Run `sudo ip link set up can0` first |
| No data on `serial_data` | Arduino receiver not connected | Check `ls /dev/ttyUSB*` and verify serial port in `can_node.py` |
| YOLOv5 import error | PyTorch not installed | `pip install torch torchvision` |
| `camarafiltro` can't open camera | Wrong device index | Edit `cv2.VideoCapture(0)` → try index 1, 2… |
| GPS node outputs no fix | Poor signal or wrong port | Ensure antenna has sky view; check `ls /dev/ttyUSB*` |
| Open3D window doesn't open | No display (SSH) | Use `ssh -X` or run on local machine with display |
| `colcon build` fails on missing package | `rosdep` not run | Re-run `rosdep install --from-paths src --ignore-src -r -y` |

---

## .gitignore Notes

The `.gitignore` excludes generated and machine-specific files:

```
build/
install/
log/
__pycache__/
*.py[cod]
*.egg-info/

# Large model weights (use Git LFS if you want to track)
*.pt
*.pth
*.onnx

# Large archives
*.zip
```

> **Do not commit** `build/`, `install/`, or `log/`. These are regenerated by `colcon build`.  
> The `yolov5nu.pt` weights file is excluded by default — document how to obtain it in the README if needed.
